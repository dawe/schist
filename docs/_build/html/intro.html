

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Introduction &mdash; schist  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Advance Plotting" href="plotting.html" />
    <link rel="prev" title="Quick start" href="quick.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> schist
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="modules.html">schist</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick.html">Quick start</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#understanding-nsbm">Understanding NSBM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bayesian-approach">Bayesian approach</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fast-model-vs-standard-approach">Fast model vs standard approach</a></li>
<li class="toctree-l3"><a class="reference internal" href="#marginals">Marginals</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="plotting.html">Advance Plotting</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">schist</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Introduction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/intro.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="understanding-nsbm">
<h2>Understanding NSBM<a class="headerlink" href="#understanding-nsbm" title="Permalink to this headline">¶</a></h2>
<p><cite>schist</cite> is based on Nested Stochastic Block Models (NSBM), a generative process based on the notion of group of nodes. Here, we use NSBM to cluster cells in scRNA-seq experiments.</p>
</div>
<div class="section" id="bayesian-approach">
<h2>Bayesian approach<a class="headerlink" href="#bayesian-approach" title="Permalink to this headline">¶</a></h2>
<p>Cell to cell relations are commonly represented as a neighborhood graph (typically KNN or  SNN), cell groups are identified as graph communities, this step is usually performed maximising graph modularity. In <cite>schist</cite>, instead, partitioning is performed maximising the  Bayesian posterior probability <strong>P(b|A)</strong>, that is the likehood of generating a network _A_ with a partition _b_ and it is obtained according to</p>
<div class="math">
<p><span class="math">\frac{ \sum_{t=0}^{N}f(t,k) }{N}</span></p>
</div><div class="math">
<p><span class="math">P(\b|\A) = \frac{P(A|\theta,b)P(\theta,b)}{P(A)}</span></p>
</div><p>Where <strong>P(A|θ,b)</strong> is the probability of obtaining the network _A_ given the partition _b_ and additional parameters _θ_; <strong>P(θ,b)</strong> is the probability of occurrence of the partition _b_ having observed the netwok _A_; <strong>P(A)</strong> is the “model evidence” and it is the same for all possible partitions. Refer to the excellent <cite>graph-tool</cite> documentation <cite>&lt;https://graph-tool.skewed.de/static/doc/demos/inference/inference.html</cite>&gt;_ for more details. Note that maximising this quantity is equivalent to minimizing the entropy</p>
<div class="math">
<p><span class="math">Sigma&amp;space;=&amp;space;-\ln&amp;space;P(\boldsymbol&amp;space;A|\boldsymbol\theta,&amp;space;\boldsymbol&amp;space;b)&amp;space;-&amp;space;\ln&amp;space;P(\boldsymbol\theta,&amp;space;\boldsymbol&amp;space;b)&quot; title=&quot;\Sigma = -\ln P(\boldsymbol A|\boldsymbol\theta, \boldsymbol b) - \ln P(\boldsymbol\theta, \boldsymbol b)</span></p>
</div><p>The nested model introduces a hierarchy of priors used to infer the optimal recursive grouping of single cell groups. If you are familiar with Leiden or Louvain methods to find cell groups, you may think at this multilevel approach as a multiresolution one, except that it is not. Here, not only the cell groups at each hierarchy level are found maximising the equation above, but the hierarchy itself (hence the groups of groups) is part of the model.
Since there may be more than one fit with similar probability, <cite>schist</cite> uses the <cite>graph-tool</cite> routines to apply a Markov chain Monte Carlo sampling of the posterior distribution aiming to converge to the best model.
One of the main limitations of <cite>schist</cite> is that it requires significantly more time than any other state of the art approach to identify cell groups. This cost comes with the benefit that it is possible to choose between different parameters according to the likelihood of a partition set to be found over a network.</p>
<div class="section" id="fast-model-vs-standard-approach">
<h3>Fast model vs standard approach<a class="headerlink" href="#fast-model-vs-standard-approach" title="Permalink to this headline">¶</a></h3>
<p>In the standard approach, the model is initialized by minimizing the description length (entropy). This requires extra time but, in general, returns better results. It is possible to achieve good results with lower memory footprint and in shorter times settting <cite>fast_model</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nested_model</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">fast_model</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will seed the model with a dummy partition scheme, then a greedy merge-split MCMC will explore solutions until it converges.</p>
</div>
<div class="section" id="marginals">
<h3>Marginals<a class="headerlink" href="#marginals" title="Permalink to this headline">¶</a></h3>
<p>When using the following invocation</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nested_model</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">collect_marginals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">equilibrate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>an additional step (with fixed number of iterations) is added to execution. During this step, <cite>schist</cite> collects the probability of having a certain number of groups for each level of the hierarchy. These are stored into <cite>adata.uns[‘nsbm’][‘group_marginals’]</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">level</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;nsbm&#39;</span><span class="p">][</span><span class="s1">&#39;group_marginals&#39;</span><span class="p">][</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;nsbm&#39;</span><span class="p">][</span><span class="s1">&#39;group_marginals&#39;</span><span class="p">][</span><span class="n">level</span><span class="p">]</span> <span class="o">/</span> <span class="n">S</span>
<span class="n">ng</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">bar</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">xticks</span><span class="p">(</span><span class="n">ng</span><span class="p">)</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of groups&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Group marginals for level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/gm.png"><img alt="alternate text" class="align-center" src="_images/gm.png" style="width: 500px; height: 400px;" /></a>
<p>Prior to version 0.3.4, this option would have collected posterior probabilities of cells to belong to a certain group. Since this quantity is interesting and it would have required a long time to compute, we’d rather calculate variation of global entropy by moving all cells to all identified groups and transform that into a probaility, which is now stored into <cite>adata.uns[‘nsbm’][‘cell_affinity’]</cite>. Here, a dictionary keyed with NSBM levels counts the times a cell has been successfully moved to a group. These probabilities can be efficiently used as covariates when looking for marker genes, this approach will weight the belief that a cell belongs to a group. We have prepared a <a class="reference external" href="https://github.com/dawe/schist-notebooks/blob/master/Cell_Marginals.ipynb">notebook</a> showing an example.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="plotting.html" class="btn btn-neutral float-right" title="Advance Plotting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="quick.html" class="btn btn-neutral float-left" title="Quick start" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Davide Cittaro, Leonardo Morelli.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>